<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>PPk浏览器:设置</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<!-- 下面两句代码是做手机适配用的 ， 加上之后手机网页就会自动适配-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">   

<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

</head>
<body>
<h3>浏览器设置</h3>
<div class="row section">
    <div class="form-group">
    <label for="btc_address" class="col-sm-2 control-label">比特币地址</label>
    <div class="col-sm-10" align="right">
      <input type="text" class="form-control" placeholder="" id="btc_address" value="" readonly onfocus="this.select()" onmouseover="this.select()"> <button type="text" id="btc_address_summary"  class="btn btn-success" onclick='openBtcDetail();'>...</button> <button type="text" id="btn_send_btc"  class="btn btn-success" onclick='sendBTC();' disabled="true" value="">发送比特币</button> <button type="text" id="btn_new_address"  class="btn btn-success" onclick='generateNewAddress();' disabled="true" value="">创建新地址</button> <button type="text"  id="btn_import_prvkey"  class="btn btn-success" onclick='importPrivateKey();'  disabled="true">导入已有地址</button>
    </div>
    </div>
</div>
<div class="row section">
    <div class="form-group">
    <label for="odin_register_num" class="col-sm-2 control-label">已注册ODIN标识数量</label>
    <div class="col-sm-10" align="right">
      <span class="help-block" id="odin_register_num" align="left">...</span>
    </div>
    </div>
    <div class="form-group">
    <label for="last_register_odin" class="col-sm-2 control-label">最近注册的ODIN标识</label>
    <div class="col-sm-10" align="right">
      <span class="help-block" id="last_register_odin" align="left">...</span>
    </div>
    </div>
    <div class="col-sm-12"  align="right">
      <div id="odin_buttons"><button type="text" id="btn_new_odin_fast"  class="btn btn-success" onclick='newOdinFast();'>快速新注册一个ODIN标识</button><!-- 
      <button type="text" id="btn_new_odin_fast"  class="btn btn-success" onclick='callback_newOdinFastSignTX("OK",{"signed_tx_hex":"0100000004fd2180f82404eb1eb95e3306abf9de58832ee821bd597566bae0eacc1133d2f0020000006b483045022100b6c745e6540785c3fe68e19e948a2523c19a83102445faa74e9962dd76d947cf02204b8f0bc3750810baa9a8ad9e5ac8bd283f11beedb12f82c0e35fbbba12960caf0121024e3b96ca0187d3b5f7427fd6cba370735d43070d9b1f45ba7e8e50c69aea83e8fffffffffd2180f82404eb1eb95e3306abf9de58832ee821bd597566bae0eacc1133d2f0000000004a00483045022100a11ba52474110e9beca30167167bb3a9517161f48bb7eeaf8b336bdb34bfda6202203de5bde7f8197e733c285e0618ababdcc54fd5f95bd8aab3c25e41ede4edaf1401ffffffff1b93a91401cc67eacbecdba413bc5ec7bb10bdf6f6f6e4a9e7117bee29f9cb02000000004900473044022053d3d072ddb03f36fcc8ec40399b77a49d2614e79d5bd93a2cf980623d39838302204f188b810e052950574a0b8d9219575e9a954fcfe8907d1a2763377356620c4e01ffffffff6cb4057ba36a55cecf76621ca3391392d3a196fbd4114255e205bafdf571d87a000000004a00483045022100c88377cc71cd3115e381d30927589d8226e4e7e13938af6e681bd8ee9c533f3502201c57caf04860ccb094093ae5fb1138799ccc192c9ec1a4884fa1d6e78d52de9601ffffffff03e803000000000000695121024e3b96ca0187d3b5f7427fd6cba370735d43070d9b1f45ba7e8e50c69aea83e82102d173743cd0d94f64d241d82a42c6ca92327c443e489f3842464a4df118d4920a21031f52543c7b22766572223a312c2261757468223a2230222c22782d746f6f6c2253ae0000000000000000226a203a2250506b54657374302e3830373031222c227469746c65223a22313131227d28230000000000001976a914b4e2b540b202be227031921163c419f9fa2224ce88ac00000000"});'>测试TX</button>-->
      </div>
    </div>
</div>
<div class="row section">
    <div class="form-group">
    <label for="odin_tool_url" class="col-sm-2 control-label">注册管理扩展服务网址</label>
    <div class="col-sm-10" align="right">
      <input type="text" class="form-control" placeholder="" id="odin_tool_url" value="http://tool.ppkpub.org:9876/odin" > <button type="text" id="btn_open_odin_tool"  class="btn btn-success" onclick='openOdinTool();'>打开</button><!-- <button type="text" class="btn btn-success" onclick='document.getElementById("odin_tool_url").value="http://192.168.62.99:12345/odin";'>本地测试</button> <button type="text" class="btn btn-success" onclick='document.getElementById("odin_tool_url").value="ppk:40086/";'>PTTP网站测试</button>-->
    </div>
    </div>
</div>

<script type="text/javascript">
var PPK_ODIN_MARK_PUBKEY_HEX='0320a0de360cc2ae8672db7d557086a4e7c8eca062c0a5a4ba9922dee0aacf3e12'; //ODIN标识消息特征公钥

var PPK_PUBKEY_LENGTH=33;  //ODIN协议承载消息内容使用的单条公钥长度
var PPK_PUBKEY_EMBED_DATA_MAX_LENGTH=31;  //ODIN协议在单条公钥中最多嵌入的消息数据长度

var MAX_MULTISIG_TX_NUM = 1; //一条交易里能支持的最大数量多重签名条目
var MAX_N = 2;  //单个1ofN多重签名输出中最多允许的公钥数量N取值
var MIN_FEE_SATOSHI = 1000;  //给矿工的费用,单位satoshi，即0.00000001 BTC
var MAX_OP_RETURN_LENGTH = 75;   //OP_RETURN能存放数据的最大字节数
var MAX_ODIN_DATA_LENGTH=(MAX_N-2)*PPK_PUBKEY_EMBED_DATA_MAX_LENGTH+(MAX_N-1)*PPK_PUBKEY_EMBED_DATA_MAX_LENGTH*(MAX_MULTISIG_TX_NUM-1)+MAX_OP_RETURN_LENGTH;  //支持嵌入的ODIN数据最大字节数

var BTC_SATOSHI_UNIT=100000000; 

var mCurrentAddress="";

window.onload=function(){
    init();
    /*
    var test={"address":"1HVSDUmW3abkitZUoZsYMKZ2PbiKhr8Rdo"};
    callback_setNewAddress('OK',test);
    test={"status":"OK","register_num":"15","last_register_odin":{"full_odin":"559411.1747","short_odin":"39642","register":"1HVSDUmW3abkitZUoZsYMKZ2PbiKhr8Rdo","admin":"1HVSDUmW3abkitZUoZsYMKZ2PbiKhr8Rdo","block_index":"559411","block_hash":"0000000000000000000cddeb7a38abcba7bff08200b4127cbf37df1af958cbea","block_time":"1548044945"},"balance_satoshi":3000,"unconfirmed_tx_count":0};
    callback_getBtcAddressSummary('OK',test);
    */
}

function init(){
    console.log("init...");
    
    if(typeof(PeerWeb) !== 'undefined'){ //检查PPk开放协议相关PeerWeb JS接口可用性
        console.log("PeerWeb enabled");
        
        //读取PPk浏览器内置钱包中缺省比特币地址
        PeerWeb.getDefaultAddress(
            'BITCOIN',  
            'callback_setNewAddress'  //回调方法名称
        );
    }else{
        console.log("PeerWeb not valid");
        //alert("PeerWeb not valid. Please visit by PPk Browser For Android v0.2.6 above.");
    }
}

function callback_setNewAddress(status,obj_data){
    if('OK'==status){
        if(obj_data.address!=null || obj_data.address.trim().length>0){
            mCurrentAddress=obj_data.address.trim();
            document.getElementById("btc_address").value=mCurrentAddress;
            refreshAddressSummary();
        }
    }

    document.getElementById("btn_send_btc").disabled=false;
    document.getElementById("btn_new_address").disabled=false;
    document.getElementById("btn_import_prvkey").disabled=false;
}

function refreshAddressSummary(){
    document.getElementById("btc_address_summary").innerHTML="...";
    document.getElementById("odin_register_num").innerHTML="...";
    document.getElementById("last_register_odin").innerHTML="...";
    
    if(mCurrentAddress.length == 0 ){
        return;
    }
    
    //读取指定比特币地址的概要汇总信息
    PeerWeb.getAddressSummary(
        'BITCOIN',  
        mCurrentAddress,
        'callback_getBtcAddressSummary'  //回调方法名称
    );
}

function callback_getBtcAddressSummary(status,obj_data){
    if('OK'==status){
        if(obj_data!=null){
            if(typeof(obj_data.balance_satoshi) !== 'undefined'){
                document.getElementById("btc_address_summary").innerHTML="余额:"+ (obj_data.balance_satoshi/BTC_SATOSHI_UNIT)+" BTC";
            }
            
            if(typeof(obj_data.register_num) !== 'undefined'){
                document.getElementById("odin_register_num").innerHTML=obj_data.register_num;
                if(obj_data.register_num>0){
                    document.getElementById("last_register_odin").innerHTML=" 完整标识: "+obj_data.last_register_odin.full_odin + " 短标识: " + obj_data.last_register_odin.short_odin;
                }
            }            
        }
    }
}

function openBtcDetail(){
    if( mCurrentAddress.length ==0 ){
        alert('浏览器钱包还没有可用的比特币地址，请先创建或导入一个比特币地址！');
        return;
    }
    
    window.location.href="https://www.blockchain.com/btc/address/"+mCurrentAddress;
}


function generateNewAddress(){
    PeerWeb.generateNewAddress(
            'BITCOIN',
            'callback_setNewAddress'
        );
}

function importPrivateKey(){
    var private_key = prompt("请输入以5,L或K起始的比特币私钥字符串","");
    if (private_key != null){
        if( private_key.substr(0,1)=='5' || private_key.substr(0,1)=='L' || private_key.substr(0,1)=='K' ){
            PeerWeb.importPrivateKey(
                'BITCOIN',
                private_key,
                'callback_setNewAddress'
              );
        }else{
            alert("请在地址文本框里输入要导入的比特币地址私钥，必须是以5,L或K起始的字符串");
        }
    }
}

//转账发送比特币的示例
function sendBTC(){
    if(mCurrentAddress.length ==0 ){
        alert('浏览器钱包还没有可用的比特币地址，请先创建或导入一个比特币地址！');
        return;
    }
    
    var dest_address = prompt("请输入收款的比特币公开地址（以1起始的字符串）","");
    if (dest_address != null){
        if( dest_address.substr(0,1)=='1' ){
            var send_amount = prompt("请输入要发送给\n"+dest_address+"\n的BTC数额","0.0");
            if (send_amount != null){
                if(!isNaN(send_amount)){
                    var send_amount_satoshi= Math.floor( send_amount * BTC_SATOSHI_UNIT );
                    var tx_argus_json='{"source":"'+mCurrentAddress             //交易发送者地址
                                     +'","destination":"'+dest_address                 //交易接收者地址
                                     +'","amount_satoshi":'+send_amount_satoshi //转账金额,单位satoshi
                                     +',"fee_satoshi":'+MIN_FEE_SATOSHI+'}';    //给矿工的费用,单位satoshi
                    
                    document.getElementById("btn_send_btc").disabled=true;
                    document.getElementById("btn_send_btc").innerHTML="正在处理，请稍候...";
    
                    PeerWeb.getSignedTX(
                        'BITCOIN',
                        stringToHex(tx_argus_json),  //待生成交易的参数数据
                        'callback_getSignedTX'
                      );
                }else{
                    alert("输入的金额数值无效！");
                }
             }
        }else{
            alert("请在地址文本框里输入对方收款的比特币公开地址（以1起始的字符串）！");
        }
    }
}


function callback_getSignedTX(status,obj_data){
    if('OK'==status){
        //调用PeerWeb接口发送已签名的比特币交易
        PeerWeb.sendSignedTX(
                "BITCOIN",
                mCurrentAddress,  //交易发送者地址
                obj_data.signed_tx_hex,  //已签名的比特币交易数据，HEX格式
                'callback_sendBtcTX' //回调方法 
            );
    }else{
        if('CANCELED'!=status){
            alert("生成比特币转账交易失败!\n(status="+status+")\n请确认当前帐户有足够余额.");
        }
        document.getElementById("btn_send_btc").disabled=false;
        document.getElementById("btn_send_btc").innerHTML="发送比特币";
    }
}

function callback_sendBtcTX(status,obj_data){
    if('OK'==status){
        refreshAddressSummary();
        alert("已发出比特币转账交易!\点击左侧余额可以查看交易确认状态.");
    }else{
        alert("发送比特币失败!\n(status="+status+")\n网络服务可能有异常，请稍后再试.");
    }
    document.getElementById("btn_send_btc").disabled=false;
    document.getElementById("btn_send_btc").innerHTML="发送比特币";
}


function openOdinTool(){
    var odin_tool_url=document.getElementById("odin_tool_url").value;
    
    if( mCurrentAddress.length ==0 ){
        alert('浏览器钱包还没有可用的比特币地址，请先创建或导入一个比特币地址！');
        return;
    }
    
    if(odin_tool_url.trim().length == 0){
        alert('请提供有效的注册管理工具网址');
        return;
    }
    
    window.location.href=odin_tool_url+"?address="+mCurrentAddress;
}

function newOdinFast(){
    if( mCurrentAddress.length ==0 ){
        alert('浏览器钱包还没有可用的地址，请先生成或导入一个地址！');
        return;
    }
    
    var new_odin_title = prompt("请输入新标识的备注信息","");
    if (new_odin_title == null){
        return;
    }
    
    document.getElementById("btn_new_odin_fast").disabled=true;
    document.getElementById("btn_new_odin_fast").innerHTML="正在处理，请稍候...";
    
    var new_odin_data_json= genNewOdinDataJSON( 
                                mCurrentAddress ,
                                "" ,
                                new_odin_title,
                                "",
                                0
                            );
    
    //调用PeerWeb接口生成新注册ODIN标识的对应签名比特币交易
    PeerWeb.getSignedOdinBitcoinTX(
                stringToHex(new_odin_data_json),  //新注册ODIN标识的定义
                'callback_newOdinFastSignTX'  //回调方法名称
            );
}

function callback_newOdinFastSignTX(status,obj_data){
    if('OK'==status){
        //调用PeerWeb接口发送已签名的比特币交易
        PeerWeb.sendSignedTX(
                "BITCOIN",
                mCurrentAddress,  //交易发送者地址
                obj_data.signed_tx_hex,  //已签名的比特币交易数据，HEX格式
                'callback_newOdinFastSendTX' //回调方法 
            );
    }else{
        if('CANCELED'!=status){
            alert("生成注册ODIN标识的交易失败!\n(status="+status+")\n请确认当前帐户有效余额至少有 0.00003 BTC.");
        }
        document.getElementById("btn_new_odin_fast").disabled=false;
        document.getElementById("btn_new_odin_fast").innerHTML="快速注册";
    }
}

function callback_newOdinFastSendTX(status,obj_data){
    if('OK'==status){
        refreshAddressSummary();
        alert("已发出注册ODIN标识的交易!\请等待至少一个新区块确认后，通过下面的注册管理服务网址来查看结果.");
    }else{
        alert("发送注册ODIN标识的交易失败!\n(status="+status+")\n请稍后再试");
    }
    document.getElementById("btn_new_odin_fast").disabled=false;
    document.getElementById("btn_new_odin_fast").innerHTML="快速注册";
}


//构建注册新ODIN标识的JSON数据字符串
function genNewOdinDataJSON( source, destination, remark_title, email , auth_set ){
  //组织ODIN注册信息数据块
  var max_user_input_length = MAX_OP_RETURN_LENGTH - 'RTX{"ver":1,"title":"","auth":"0"}'.length;
  console.log('max_user_input_length='+max_user_input_length);
  
  var str_title_encoded=encodeURI(remark_title,"utf-8");
  if(str_title_encoded.length>max_user_input_length){
    str_title_encoded=str_title_encoded.substr(0,max_user_input_length);
  }
  
  var str_email_encoded=',"email":'+JSON.stringify(email);
  if(str_email_encoded.length+str_title_encoded.length>max_user_input_length){
    str_email_encoded="";
  }
      
  var str_odin_setting='{"ver":1,"title":"'+str_title_encoded+'"'+str_email_encoded+',"auth":"'+auth_set+'"}';
      
  console.log('str_odin_setting='+str_odin_setting);
  var str_odin_msg = 'RT'
          + String.fromCharCode(str_odin_setting.length%253)
          + str_odin_setting;  //组织ODIN注册信息
  console.log('str_odin_msg='+str_odin_msg);
  console.log('LENGTH='+str_odin_msg.length);
        
  
  //将原始字节字符串转换为用16进制表示
  var str_odin_hex=stringToHex(str_odin_msg);
  //console.log('str_odin_hex='+str_odin_hex);
  
  var odin_data_json='{"source":"'+source+'","destination":"'+destination+'","fee_satoshi":'+MIN_FEE_SATOSHI+',"mark_hex":"'+PPK_ODIN_MARK_PUBKEY_HEX+'","data_hex":"'+str_odin_hex+'"}';
  console.log('odin_data_json='+odin_data_json);

  return odin_data_json;
}
   
//Ascii/Unicode字符串转换成16进制表示
function stringToHex(str){
    var val="";
    for(var i = 0; i < str.length; i++){
        var tmpstr=str.charCodeAt(i).toString(16);  //Unicode
        val += tmpstr.length==1? '0'+tmpstr : tmpstr;  
    }
    return val;
}

</script>
</body>
