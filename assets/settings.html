<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>PPk浏览器:设置</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<!-- 下面两句代码是做手机适配用的 ， 加上之后手机网页就会自动适配-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">   

<link rel="stylesheet" href="css/bootstrap.min.css">
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>

</head>
<body>
<h3>浏览器设置</h3>
<div class="row section">
  <div class="form-group">
    <label for="btc_address" class="col-sm-2 control-label">比特币地址</label>
    <div class="col-sm-10" align="right">
      <input type="text" class="form-control" placeholder="" id="btc_address" value="" readonly onfocus="this.select()" onmouseover="this.select()"> <button type="text" id="btc_address_summary"  class="btn btn-success" onclick='openBtcDetail();'>...</button> <button type="text" id="btn_send_btc"  class="btn btn-success" onclick='sendBTC();' disabled="true" value="">发送比特币</button><br> <button type="text" id="btn_change_address"  class="btn btn-success" onclick='changeBtcAnotherAddress();' disabled="true" value="">切换其它地址</button>  <button type="text" id="btn_new_address"  class="btn btn-success" onclick='generateNewAddress();' disabled="true" value="">创建新地址</button> <button type="text"  id="btn_import_prvkey"  class="btn btn-success" onclick='importPrivateKey();'  disabled="true">导入新地址</button>
    </div>
  </div>

  <div class="form-group">
    <label for="related_odin_info" class="col-sm-2 control-label">当前地址相关奥丁号信息</label>
    <div class="col-sm-10" align="left">
      <span id="related_odin_info">
      已注册数：<span id="odin_register_num">...</span><br>
      最近注册：<span id="last_register_odin">...</span><br>
      待确认交易数：<span id="unconfirmed_tx_count">...</span><br>
      <font size="-2">（注：待确认交易数包括ODIN注册、普通转账等多类交易在内，仅供参考）</font>
      </span>
    </div>
  </div>

  <div class="form-group">
    <div class="col-sm-12"  align="right">
      <button type="text" id="btn_new_odin_fast"  class="btn btn-success" onclick='newOdinFast();'>快速新注册一个奥丁号</button>
    </div>
  </div>

  <div class="form-group">
    <label for="odin_tool_url" class="col-sm-2 control-label">注册管理奥丁号服务网址</label>
    <div class="col-sm-10" align="right">
      <select class="form-control" id="odin_tool_url" >
      <option value="http://47.114.169.156:9876/" selected>杭州: http://47.114.169.156:9876/</option>
      <option value="http://tool.ppkpub.org:9876/">新加坡: http://tool.ppkpub.org:9876/</option>
      </select>
      <button type="text" id="btn_open_odin_tool"  class="btn btn-success" onclick='openOdinTool();'>打开</button><!-- <button type="text" class="btn btn-success" onclick='document.getElementById("odin_tool_url").value="http://192.168.62.99:12345/";'>本地测试</button> <button type="text" class="btn btn-success" onclick='document.getElementById("odin_tool_url").value="ppk:40086/";'>PTTP网站测试</button>  -->
    </div>
  </div>
</div>

<h3>开放自主的用户身份</h3>
<div class="row section">
  <div class="form-group">
    <label for="default_odin" class="col-sm-2 control-label">当前使用的身份标识</label>
    <div class="col-sm-10" align="right">
      <input type="text" class="form-control" placeholder="" id="default_odin" value="" onfocus="this.select()" onmouseover="this.select()" readonly>
      <button type="text" class="btn btn-success" onclick='viewDefaultID();'>查看开放信息</button> <button type="text"  class="btn btn-success" onclick='openOdinTool();'>从我注册的奥丁号中选取</button> <button type="text" class="btn btn-success" onclick='genPayCode();'>生成我的收款码</button>
    </div>
  </div>

  <div class="form-group">
    <label for="odin_online_pubkey" class="col-sm-2 control-label">已发布到网络上的公钥（供第三方验证身份签名时使用）</label>
    <div class="col-sm-10" align="right">
      <textarea class="form-control" placeholder="" id="odin_online_pubkey" value="" rows=3 onfocus="this.select()" onmouseover="this.select()"></textarea>
      <button type="text" id="btn_test_sign"  class="btn btn-success" onclick='testKeyOfDefaultID();'>测试密钥签名</button>
    </div>
  </div>

  <div class="form-group">
    <label for="odin_local_pubkey" class="col-sm-2 control-label">本机保存的身份密钥</label>
    <div class="col-sm-10" align="right">
      <textarea class="form-control" placeholder="" id="odin_local_pubkey" value="" rows=3 onfocus="this.select()" onmouseover="this.select()"></textarea>
      <button type="text"  class="btn btn-success" onclick='setKeyOfDefaultID();'>查看/配置密钥</button> <button type="text" id="btn_update_online_pubkey"  class="btn btn-success" disabled="true" onclick='updateOnlinePubkey();'>更新公钥到网络上</button>
    </div>
  </div>
</div>

<h3>开放自主的数字资产</h3>
<div class="row section">
  <div class="form-group">
    <label for="ext_asset_odin_uri" class="col-sm-2 control-label">可选的资产/币种列表</label>
    <div class="col-sm-10" align="right">
      <select id="ext_asset_list" class="form-control" >
      <option value="ppk:bch/" selected>ppk:bch/ - 比特现金(BitcoinCash)</option>
      <!--<option value="ppk:btm/" selected>ppk:btm/ - 比原链(Bytom)</option>-->
      </select>
    </div>
  </div>

  <div class="form-group">
    <label for="ext_asset_address" class="col-sm-2 control-label">对应资产地址</label>
    <div class="col-sm-10" align="right">
      <input type="text" class="form-control" placeholder="" id="ext_asset_address" value="" readonly onfocus="this.select()" onmouseover="this.select()"> <button type="text" id="ext_asset_summary"  class="btn btn-success" onclick='openExtAssetDetail();'>...</button> <button type="text" id="btn_send_ext_asset"  class="btn btn-success" onclick='sendExtAsset();' disabled="true" value="">转账发送</button><!-- <button type="text" id="ext_asset_change_address"  class="btn btn-success" onclick='changeExtAssetAddress();' disabled="true" value="">切换其它地址</button>  <button type="text" id="ext_asset_new_address"  class="btn btn-success" onclick='generateExtAssetAddress();'  value="">创建新地址</button> <button type="text"  id="ext_asset_import_prvkey"  class="btn btn-success" onclick='importExtAssetPrivateKey();'  disabled="true">导入新地址</button>-->
    </div>
  </div>
  
  <p><font size="-2">注：后续将逐步增加支持更多数字资产/币种，如ETH、BTM、EOS、LTC等。</font></p>
</div>

<h3>高级设置</h3>
<div class="row section">
  <div class="form-group">
    <label for="odin_tool_url" class="col-sm-2 control-label">主页网址</label>
    <div class="col-sm-10" align="right">
      <input type="text" class="form-control" placeholder="" id="homepage_uri" value="ppk:0/" readonly > <button type="text"  class="btn btn-success" onclick='setPPkPayAsHomePage();'>将奥丁号收款码设为主页</button> <button type="text"  class="btn btn-success" onclick='setHomePage();'>自定义主页</button>
    </div>
  </div>
  
  <div class="form-group">
    <label for="standard_fee_satoshi" class="col-sm-2 control-label">本机注册/转账花费的比特币矿工费用</label>
    <div class="col-sm-10" align="right">
      <span class="help-block" id="standard_fee_satoshi" align="left"><span id="btc_standard_fee_satoshi">...</span>聪（注:1聪 等于 0.00000001 BTC）</span>
      <button type="text" id="btn_set_btc_standard_fee_satoshi"  class="btn btn-warning" onclick='setBtcStandardFeeSatoshi();'>设置</button>
    </div>
  </div>
  
  <div class="form-group">
    <label for="standard_fee_satoshi" class="col-sm-2 control-label">网络内容缓存</label>
    <div class="col-sm-10" align="right">
      <button type="text" id="btn_clear_net_cache"  class="btn btn-danger" onclick='clearNetCache();'>清除缓存</button>
    </div>
  </div>

  <div class="form-group">
    <label for="btn_backup_private_data" class="col-sm-2 control-label">备份或恢复应用数据(包括比特币私钥、身份验证密钥等)</label>
    <div class="col-sm-10" align="right">
      <button type="text" id="btn_backup_private_data"  class="btn btn-danger" onclick='backupPrivateData();'>备份/恢复</button>
    </div>
  </div>
  
  <center>
      <button type="text" id="btn_updateNewVersion"  class="btn btn-warning" style="width: 75%;" onclick='updateNewVersion();'>检查最新版本</button>
  </center>
</div>


<script type="text/javascript">
var PPK_ODIN_MARK_PUBKEY_HEX='0320a0de360cc2ae8672db7d557086a4e7c8eca062c0a5a4ba9922dee0aacf3e12'; //奥丁号消息特征公钥

var PPK_PUBKEY_LENGTH=33;  //ODIN协议承载消息内容使用的单条公钥长度
var PPK_PUBKEY_EMBED_DATA_MAX_LENGTH=31;  //ODIN协议在单条公钥中最多嵌入的消息数据长度

var MAX_MULTISIG_TX_NUM = 1; //一条交易里能支持的最大数量多重签名条目
var MAX_N = 2;  //单个1ofN多重签名输出中最多允许的公钥数量N取值
var MIN_FEE_SATOSHI = 1000;  //给矿工的费用,单位satoshi，即0.00000001 BTC
var MAX_OP_RETURN_LENGTH = 75;   //OP_RETURN能存放数据的最大字节数
var MAX_ODIN_DATA_LENGTH=(MAX_N-2)*PPK_PUBKEY_EMBED_DATA_MAX_LENGTH+(MAX_N-1)*PPK_PUBKEY_EMBED_DATA_MAX_LENGTH*(MAX_MULTISIG_TX_NUM-1)+MAX_OP_RETURN_LENGTH;  //支持嵌入的ODIN数据最大字节数

var BTC_SATOSHI_UNIT=100000000; 

var mCurrentAddress="";
var mTempDataHex;
var mDefaultOdinPubKey;

window.onload=function(){
    init();
    /*
    var test;
    
    test={"address":"1HVSDUmW3abkitZUoZsYMKZ2PbiKhr8Rdo"};
    callback_setBtcNewAddress('OK',test);
    test={"status":"OK","register_num":"15","last_register_odin":{"full_odin":"559411.1747","short_odin":"39642","register":"1HVSDUmW3abkitZUoZsYMKZ2PbiKhr8Rdo","admin":"1HVSDUmW3abkitZUoZsYMKZ2PbiKhr8Rdo","block_index":"559411","block_hash":"0000000000000000000cddeb7a38abcba7bff08200b4127cbf37df1af958cbea","block_time":"1548044945"},"balance_satoshi":3000,"unconfirmed_tx_count":0};
    callback_getBtcAddressSummary('OK',test);
    */
    
    //var test={"StandardFeeSatoshi":"500"};
    //callback_getStandardFeeSatoshi('OK',test);
}

function init(){
    console.log("init...");
    
    document.getElementById("btc_standard_fee_satoshi").innerHTML=""+MIN_FEE_SATOSHI;
    
    if(typeof(PeerWeb) !== 'undefined'){ //检查PPk开放协议相关PeerWeb JS接口可用性
        console.log("PeerWeb enabled");
        
        //读取PPk浏览器的缺省比特币矿工费用设置
        PeerWeb.getDefaultSetting(
            'StandardFeeSatoshi',
            'callback_getStandardFeeSatoshi'  //回调方法名称
        );
        
        //读取PPk浏览器内置钱包中缺省比特币地址
        PeerWeb.getDefaultAddress(
            'ppk:btc/',  
            'callback_setBtcNewAddress'  //回调方法名称
        );
        
        //读取PPk浏览器内置钱包中缺省用户身份标识
        PeerWeb.getDefaultODIN(
            'callback_setNewODIN'  //回调方法名称
        );
        
        //读取PPk浏览器内置钱包中缺省比特现金地址
        PeerWeb.getDefaultAddress(
            'ppk:bch/',  
            'callback_setExtAssetNewAddress'  //回调方法名称
        );
        
        //读取PPk浏览器的缺省主页设置
        PeerWeb.getDefaultSetting(
            'Homepage',
            'callback_getHomepage'  //回调方法名称
        );
    }else{
        console.log("PeerWeb not valid");
        //alert("PeerWeb not valid. Please visit by PPk Browser For Android v0.2.6 above.");
    }
}


//设置相关
function backupPrivateData(){
    PeerWeb.backupPrivateData(
        'callback_backupPrivateData'  //回调方法名称
    );
}

function callback_backupPrivateData(status,obj_data){
    if('OK'==status){
        //成功时自动刷新
        location.reload();
    }else{
       //出错提示
       alert("备份出错！\n" + status + ":" + ( typeof(obj_data.errdesc) !== 'undefined' ? obj_data.errdesc:"未知原因" ) );
    }
}

function updateNewVersion(){
    PeerWeb.updateNewVersion( );
}

function setBtcStandardFeeSatoshi(){
    PeerWeb.setDefaultSetting(
            'StandardFeeSatoshi',
            'callback_getStandardFeeSatoshi'  //回调方法名称
        );
}

function callback_getStandardFeeSatoshi(status,obj_data){
    if('OK'==status){
        //alert("obj_data.StandardFeeSatoshi="+obj_data.StandardFeeSatoshi);
        if(obj_data.StandardFeeSatoshi!=null){
          if(Math.round(obj_data.StandardFeeSatoshi)>=500 && Math.round(obj_data.StandardFeeSatoshi)<=20000){
            MIN_FEE_SATOSHI=Math.round(obj_data.StandardFeeSatoshi);
            document.getElementById("btc_standard_fee_satoshi").innerHTML=""+MIN_FEE_SATOSHI;
          }else{
            alert("无效的矿工费用数值，请重新设置！\n默认为1000，可设范围为500-20000。\n给矿工的费用越高，交易会被更优先确认收录到区块链上。");
          }
        }
    }
}

function setHomePage(){
    PeerWeb.setDefaultSetting(
            'Homepage',
            'callback_getHomepage'  //回调方法名称
        );
}

function setPPkPayAsHomePage(){
    PeerWeb.setPPkPayAsHomePage(
            'callback_getHomepage'  //回调方法名称
        );
}

function callback_getHomepage(status,obj_data){
    if('OK'==status){
        if(obj_data.Homepage!=null){
            document.getElementById("homepage_uri").value=obj_data.Homepage;
        }
    }
}

function clearNetCache(){
    PeerWeb.clearNetCache(
            'ALL',
            'callback_clearNetCache'  //回调方法名称
        );
}

function callback_clearNetCache(status,obj_data){
    if('OK'!=status){
       //出错提示
       alert("清理缓存出错！\n" + status + ":" + ( typeof(obj_data.errdesc) !== 'undefined' ? obj_data.errdesc:"未知原因" ) );
    }
}

//BTC相关
function changeBtcAnotherAddress(){
    //切换使用PPk浏览器内置钱包中的其它比特币地址
    PeerWeb.changeAnotherAddress(
        'ppk:btc/',  
        'callback_setBtcNewAddress'  //回调方法名称
    );
}

function callback_setBtcNewAddress(status,obj_data){
    if('OK'==status){
        if(obj_data.address!=null || obj_data.address.trim().length>0){
            mCurrentAddress=obj_data.address.trim();
            document.getElementById("btc_address").value=mCurrentAddress;
            refreshBtcAddressSummary();
        }
    }

    document.getElementById("btn_send_btc").disabled=false;
    document.getElementById("btn_change_address").disabled=false;
    document.getElementById("btn_new_address").disabled=false;
    document.getElementById("btn_import_prvkey").disabled=false;
}

function refreshBtcAddressSummary(){
    document.getElementById("btc_address_summary").innerHTML="...";
    document.getElementById("odin_register_num").innerHTML="...";
    document.getElementById("last_register_odin").innerHTML="...";
    document.getElementById("unconfirmed_tx_count").innerHTML="...";

    if(mCurrentAddress.length == 0 ){
        return;
    }
    
    //读取指定比特币地址的概要汇总信息
    PeerWeb.getAddressSummary(
        'ppk:btc/',  
        mCurrentAddress,
        'callback_getBtcAddressSummary'  //回调方法名称
    );
}

function callback_getBtcAddressSummary(status,obj_data){
    if('OK'==status){
        if(obj_data!=null){
            if(typeof(obj_data.balance_satoshi) !== 'undefined'){
                var tmpstr = "余额:"+ (obj_data.balance_satoshi/BTC_SATOSHI_UNIT)+" BTC";
                if(obj_data.balance_satoshi<3000){
                    tmpstr += "(不足)";
                }else if(obj_data.balance_satoshi>20000){
                    tmpstr += "(过多！)";
                }
                document.getElementById("btc_address_summary").innerHTML = tmpstr;
            }
            if(typeof(obj_data.register_num) !== 'undefined'){
                document.getElementById("odin_register_num").innerHTML=obj_data.register_num;
                if(obj_data.register_num>0){
                    document.getElementById("last_register_odin").innerHTML=" 完整标识: "+obj_data.last_register_odin.full_odin + " 短标识: " + obj_data.last_register_odin.short_odin;
                }
            } 
            if(typeof(obj_data.unconfirmed_tx_count) !== 'undefined'){
                document.getElementById("unconfirmed_tx_count").innerHTML=obj_data.unconfirmed_tx_count;
            }
        }
    }
}

function openBtcDetail(){
    if( mCurrentAddress.length ==0 ){
        alert('浏览器钱包还没有可用的比特币地址，请先创建或导入一个比特币地址！');
        return;
    }
    
    window.location.href="https://www.blockchain.com/btc/address/"+mCurrentAddress;
}


function generateNewAddress(){
    PeerWeb.generateNewAddress(
            'ppk:btc/',
            'callback_setBtcNewAddress'
        );
}

function importPrivateKey(){
    var private_key = prompt("请输入以5,L或K起始的比特币私钥字符串","");
    if (private_key != null){
        private_key=private_key.trim();
        if( private_key.substr(0,1)=='5' || private_key.substr(0,1)=='L' || private_key.substr(0,1)=='K' ){
            PeerWeb.importPrivateKey(
                'ppk:btc/',
                private_key,
                'callback_setBtcNewAddress'
              );
        }else{
            alert("请在地址文本框里输入要导入的比特币地址私钥，必须是以5,L或K起始的字符串");
        }
    }
}

//转账发送比特币的示例
function sendBTC(){
    if(mCurrentAddress.length ==0 ){
        alert('浏览器钱包还没有可用的比特币地址，请先创建或导入一个比特币地址！');
        return;
    }
    
    var dest_address = prompt("请输入收款的奥丁号（以ppk:起始）或比特币公开地址（以1,3起始的字符串）","");
    if (dest_address != null){
        if( dest_address.substr(0,1)=='1' || dest_address.substr(0,1)=='3' || dest_address.substr(0,4)=='ppk:' ){
            var send_amount = prompt("请输入要发送给\n"+dest_address+"\n的BTC数额：","0.0");
            if (send_amount != null){
                if(!isNaN(send_amount)){
                    var send_amount_satoshi= Math.round( parseFloat(send_amount) * BTC_SATOSHI_UNIT );
                    var tx_argus_json='{"source":"'+mCurrentAddress             //交易发送者地址
                                     +'","destination":"'+dest_address                 //交易接收者地址
                                     +'","amount_satoshi":'+send_amount_satoshi //转账金额,单位satoshi
                                     +',"fee_satoshi":'+MIN_FEE_SATOSHI+'}';    //给矿工的费用,单位satoshi
                    
                    document.getElementById("btn_send_btc").disabled=true;
                    document.getElementById("btn_send_btc").innerHTML="正在处理，请稍候...";
    
                    PeerWeb.getSignedTX(
                        'ppk:btc/',
                        stringToHex(tx_argus_json),  //待生成交易的参数数据
                        'callback_getSignedTX'
                      );
                }else{
                    alert("输入的金额数值无效！");
                }
             }
        }else{
            alert("请在地址文本框里输入对方收款的奥丁号（以ppk:起始）或比特币公开地址（以1,3起始）！");
        }
    }
}


function callback_getSignedTX(status,obj_data){
    if('OK'==status){
        //调用PeerWeb接口发送已签名的比特币交易
        PeerWeb.sendSignedTX(
                "ppk:btc/",
                mCurrentAddress,  //交易发送者地址
                obj_data.signed_tx_hex,  //已签名的比特币交易数据，HEX格式
                'callback_sendBtcTX' //回调方法 
            );
    }else{
        if('CANCELED'!=status){
            alert("生成比特币转账交易失败!\n(status="+status+")\n请确认当前帐户有足够余额.");
        }
        document.getElementById("btn_send_btc").disabled=false;
        document.getElementById("btn_send_btc").innerHTML="发送比特币";
    }
}

function callback_sendBtcTX(status,obj_data){
    if('OK'==status){
        refreshBtcAddressSummary();
        alert("已发出比特币转账交易!\点击左侧余额可以查看交易确认状态.");
    }else{
        alert("发送比特币失败!\n(status="+status+")\n网络服务可能有异常，请稍后再试.");
    }
    document.getElementById("btn_send_btc").disabled=false;
    document.getElementById("btn_send_btc").innerHTML="发送比特币";
}

//ODIN和身份相关

//判断是否为ODIN根标识
function isRootODIN(uri){
    var parts = uri.split("/");
    
    if(parts.length==1)
        return true;
    
    if(parts.length>2)
        return false;
    
    if(parts[1].trim().length==0)
        return true;
    
    var parts2 = parts[1].split("#");
    if(parts2[0].trim().length==0)
        return true;
    else
        return false;
}

function callback_setNewODIN(status,obj_data){
    if('OK'==status){
        if(obj_data.odin_uri!=null && obj_data.odin_uri.trim().length>0){
            document.getElementById("default_odin").value=obj_data.odin_uri.trim();
            
            PeerWeb.getPPkResourcePubkey(
                obj_data.odin_uri,
                'callback_getDefaultOdinPubkey'  //回调方法名称
            );
        }
    }
}

function callback_getDefaultOdinPubkey(status,obj_data){
    if('OK'==status){
        try{
            document.getElementById("odin_online_pubkey").value=obj_data.online_pubkey;
            document.getElementById("odin_local_pubkey").value=obj_data.local_pubkey;
            
            mDefaultOdinPubKey=document.getElementById("odin_online_pubkey").value;
            var local_pubkey=document.getElementById("odin_local_pubkey").value;
            
            document.getElementById("odin_online_pubkey").value=obj_data.online_algo+":"+mDefaultOdinPubKey;
            document.getElementById("odin_local_pubkey").value=obj_data.local_algo+":"+local_pubkey;

            if( mDefaultOdinPubKey.length>0 && mDefaultOdinPubKey==local_pubkey  ){
                document.getElementById("odin_local_pubkey").value="本机密钥有效，对应公钥已发布到网络上；对应的私钥只在本机安全保存，可在验证身份时自主签名。";
                document.getElementById("btn_update_online_pubkey").disabled=true;
            }else if(local_pubkey!=mDefaultOdinPubKey && local_pubkey.length>0 ){
                document.getElementById("btn_update_online_pubkey").disabled=false;
            }
        }catch(e){
            document.getElementById("odin_online_pubkey").value="获取的开放身份标识公钥信息有误!\n"+e;
            document.getElementById("odin_local_pubkey").value=document.getElementById("odin_online_pubkey").value;
            document.getElementById("btn_update_online_pubkey").disabled=true;
        }
    }else{
        document.getElementById("odin_online_pubkey").value="无法获取到开放身份标识对应密钥！\n请检查确认";
        document.getElementById("odin_local_pubkey").value=document.getElementById("odin_online_pubkey").value;
        document.getElementById("btn_update_online_pubkey").disabled=true;
    }
}

function openOdinTool(){
    var odin_tool_url=document.getElementById("odin_tool_url").value;
    
    if( mCurrentAddress.length ==0 ){
        alert('浏览器钱包还没有可用的比特币地址，请先创建或导入一个比特币地址！');
        return;
    }
    
    if(odin_tool_url.trim().length == 0){
        alert('请提供有效的注册管理工具网址');
        return;
    }
    
    window.location.href=odin_tool_url+"odin?address="+mCurrentAddress;
}

function updateOnlinePubkey(){
    var odin_tool_url=document.getElementById("odin_tool_url").value;
    
    if(odin_tool_url.trim().length == 0){
        alert('请提供有效的注册管理工具网址');
        return;
    }
    
    var default_odin_uri=document.getElementById("default_odin").value;
    if( default_odin_uri.length == 0 ){
        alert('请先通过奥丁号管理工具选取一个奥丁号作为你的开放身份！');
        return;
    }
    
    if(!isRootODIN(default_odin_uri)){
        alert("注意，对于二级以上扩展标识，需要按相应标识服务的定义，将新设置的公钥相应发布到网络上生效。");
        return;
    }
    
    var tmp_odin= default_odin_uri.substr(4,default_odin_uri.length-4-1);
    
    window.location.href=odin_tool_url+"odin-update-vd?odin="+tmp_odin+"&address="+mCurrentAddress;
}

function viewDefaultID(){
    var default_odin_uri=document.getElementById("default_odin").value;
    
    if( default_odin_uri.length ==0 ){
        alert('请先通过标识管理工具选取一个奥丁号作为你的开放身份！');
        return;
    }
    
    //读取用户身份标识URI对应说明
    PeerWeb.getPPkResource(
        default_odin_uri,
        'content',
        'callback_getDefaultUserOdinInfo'  //回调方法名称
    );
}

function genPayCode(){
    var default_odin_uri=document.getElementById("default_odin").value;
    
    if( default_odin_uri.length ==0 ){
        alert('请先通过标识管理工具选取一个奥丁号作为你的收款地址！');
        return;
    }
    
    window.location = "paycode.html";
}

function callback_getDefaultUserOdinInfo(status,obj_data){
    if('OK'==status){
        try{
            var content=window.atob(obj_data.content_base64);
            //var content=obj_data.content_base64;
            alert("type="+obj_data.type+" \nlength="+obj_data.length+"\ncontent="+content+"\nservice_url="+obj_data.url);
        }catch(e){
            alert("获得的用户标识信息有误!\n"+e);
        }
    }else{
        alert("无法获取标识对应用户信息！\n请检查确认");
    }
}


function setKeyOfDefaultID(){
    var default_odin_uri=document.getElementById("default_odin").value;
    
    if( default_odin_uri.length ==0 ){
        alert('请先通过标识管理工具选取一个奥丁号作为你的开放身份！');
        return;
    }
    
    PeerWeb.setPPkResourceKey(
        default_odin_uri,
        'callback_setPPkResourceKey'  //回调方法名称
    );
    
    //window.location.href=odin_tool_url+"odin?address="+mCurrentAddress;
}
function callback_setPPkResourceKey(status,obj_data){
    if('OK'==status){
        try{
            document.getElementById("odin_local_pubkey").value=obj_data.local_pubkey;
            var online_pubkey=document.getElementById("odin_online_pubkey").value;
            var local_pubkey=document.getElementById("odin_local_pubkey").value;
            
            online_pubkey=online_pubkey.replace(/[\r\n]/g,"").replace(/\ +/g,""); //去除空格、回车、换行
            local_pubkey=local_pubkey.replace(/[\r\n]/g,"").replace(/\ +/g,""); //去除空格、回车、换行
            
            if(local_pubkey==online_pubkey && online_pubkey.length>0 ){
                document.getElementById("odin_local_pubkey").value="本机密钥有效，对应公钥已发布到网络上；对应的私钥只在本机安全保存，可在验证身份时自主签名。";
                document.getElementById("btn_update_online_pubkey").disabled=true;
            }else if(local_pubkey!=online_pubkey && local_pubkey.length>0 ){
                document.getElementById("btn_update_online_pubkey").disabled=false;
                
                if(isRootODIN(document.getElementById("default_odin").value)){
                    var con;
                    con=confirm("需要将新设置的公钥发布到网络上才能生效。\n现在就更新吗?"); //在页面上弹出对话框
                    if(con==true){
                        updateOnlinePubkey();
                    }
                }else{
                    alert("注意，对于二级以上扩展标识，需要按相应标识服务的定义，将新设置的公钥相应发布到网络上生效。");
                }
            }
        }catch(e){
            //alert("获取的开放身份标识公钥信息有误!\n"+e);
            document.getElementById("odin_local_pubkey").value="配置的开放身份标识公钥信息有误!";
            document.getElementById("btn_update_online_pubkey").disabled=true;
        }
    }else{
       //alert("无法获取到开放身份标识对应密钥！\n请检查确认");
       //document.getElementById("odin_local_pubkey").value="无法获取到开放身份标识对应密钥！\n请检查确认";
    }
}

function testKeyOfDefaultID(){
    var default_odin_uri=document.getElementById("default_odin").value;
    
    if( default_odin_uri.length ==0 ){
        alert('请先通过标识管理工具选取一个奥丁号作为你的开放身份！');
        return;
    }
    
    if(mDefaultOdinPubKey==null || mDefaultOdinPubKey.length==0){
        alert('请先配置好密钥并将公钥发布到网络上，等待确认后即可测试签名是否有效！');
        return;
    }
    
    try{
        var default_odin_uri=document.getElementById("default_odin").value;

        var requester_uri='about:setting';
        var auth_txt=requester_uri+','+default_odin_uri;  //需要签名的原文
        mTempDataHex = stringToHex(auth_txt);
        
        //请求用指定资源密钥来生成签名
        PeerWeb.signWithPPkResourcePrvKey(
            default_odin_uri,
            requester_uri ,
            mTempDataHex,
            'callback_signWithPPkResourcePrvKey'  //回调方法名称
        );
    }catch(e){
        alert("测试签名时出错了!\n"+e);
    }
}

function callback_signWithPPkResourcePrvKey(status,obj_data){
    if('OK'==status){
        try{
            //alert("res_uri="+obj_data.res_uri+" \nsign="+obj_data.sign+" \algo="+obj_data.algo);
            
            //验证签名
            PeerWeb.verifySign(
                mTempDataHex,
                mDefaultOdinPubKey ,
                obj_data.sign,
                obj_data.algo,
                'callback_verifySign'  //回调方法名称
            );
        }catch(e){
            alert("获得的签名信息有误!\n"+e);
        }
    }else{
        alert("无法签名指定资源！\n请检查确认该资源已配置有效的验证密钥.");
    }
}

function callback_verifySign(status,obj_data){
    if('OK'==status){
        alert("签名验证通过");
    }else{
        alert("签名无效！");
    }
}

function newOdinFast(){
    if( mCurrentAddress.length ==0 ){
        alert('浏览器钱包还没有可用的地址，请先生成或导入一个地址！');
        return;
    }
    
    var new_odin_title = prompt("请输入新标识的备注信息（可不填）","");
    if (new_odin_title == null){
        return;
    }
    
    document.getElementById("btn_new_odin_fast").disabled=true;
    document.getElementById("btn_new_odin_fast").innerHTML="正在处理，请稍候...";
    
    var new_odin_data_json= genNewOdinDataJSON( 
                                mCurrentAddress ,
                                "" ,
                                new_odin_title,
                                "",
                                "0"
                            );
    
    //调用PeerWeb接口生成新注册奥丁号的对应签名比特币交易
    PeerWeb.getSignedOdinBitcoinTX(
                stringToHex(new_odin_data_json),  //新注册奥丁号的定义
                'callback_newOdinFastSignTX'  //回调方法名称
            );
}

function callback_newOdinFastSignTX(status,obj_data){
    if('OK'==status){
        //调用PeerWeb接口发送已签名的比特币交易
        PeerWeb.sendSignedTX(
                "ppk:btc/",
                mCurrentAddress,  //交易发送者地址
                obj_data.signed_tx_hex,  //已签名的比特币交易数据，HEX格式
                'callback_newOdinFastSendTX' //回调方法 
            );
    }else{
        if('CANCELED'!=status){
            alert("生成注册奥丁号的交易失败!\n(status="+status+")\n请确认当前帐户有效余额至少有 0.00003 BTC.");
        }
        document.getElementById("btn_new_odin_fast").disabled=false;
        document.getElementById("btn_new_odin_fast").innerHTML="快速注册";
    }
}

function callback_newOdinFastSendTX(status,obj_data){
    if('OK'==status){
        refreshBtcAddressSummary();
        alert("已发出注册奥丁号的交易!\请等待至少一个新区块确认后，通过下面的注册管理服务网址来查看结果.");
    }else{
        alert("发送注册奥丁号的交易失败!\n(status="+status+")\n请稍后再试");
    }
    document.getElementById("btn_new_odin_fast").disabled=false;
    document.getElementById("btn_new_odin_fast").innerHTML="快速注册";
}


//构建注册新奥丁号的JSON数据字符串
function genNewOdinDataJSON( source, destination, remark_title, email , auth_set ){
  //组织ODIN注册信息数据块
  var max_user_input_length = MAX_OP_RETURN_LENGTH - 'RTX{"ver":1,"title":"","email":"","auth":"0"}'.length;
  console.log('max_user_input_length='+max_user_input_length);
  
  var str_title_encoded=encodeURI(remark_title,"utf-8");
  if(str_title_encoded.length>max_user_input_length){
    str_title_encoded=str_title_encoded.substr(0,max_user_input_length);
  }
  
  var str_email_encoded=',"email":'+JSON.stringify(email);
  if(str_email_encoded.length+str_title_encoded.length>max_user_input_length){
    str_email_encoded="";
  }
      
  //var str_odin_setting='{"ver":1,"title":"'+str_title_encoded+'"'+str_email_encoded+',"auth":"'+auth_set+'"}';
  var obj_odin_setting={
        "ver":1,
        "title":str_title_encoded,
        "email":email,
        "auth": auth_set
    };

  var str_odin_setting= JSON.stringify(obj_odin_setting);
      
  console.log('str_odin_setting='+str_odin_setting);
  var str_odin_msg = 'RT'
          + String.fromCharCode(str_odin_setting.length%253)
          + str_odin_setting;  //组织ODIN注册信息
  console.log('str_odin_msg='+str_odin_msg);
  console.log('LENGTH='+str_odin_msg.length);
        
  
  //将原始字节字符串转换为用16进制表示
  var str_odin_hex=stringToHex(str_odin_msg);
  //console.log('str_odin_hex='+str_odin_hex);
  
  var odin_data_json='{"source":"'+source+'","destination":"'+destination+'","fee_satoshi":'+MIN_FEE_SATOSHI+',"mark_hex":"'+PPK_ODIN_MARK_PUBKEY_HEX+'","data_hex":"'+str_odin_hex+'"}';
  console.log('odin_data_json='+odin_data_json);

  return odin_data_json;
}

//扩展资产币种相关
function generateExtAssetAddress(){
    var ext_asset_odin_uri=document.getElementById("ext_asset_odin_uri").value;
    PeerWeb.generateNewAddress(
            ext_asset_odin_uri,
            'callback_setExtAssetNewAddress'
        );
}
function callback_setExtAssetNewAddress(status,obj_data){
    if('OK'==status){
        if(obj_data.address!=null || obj_data.address.trim().length>0){
            document.getElementById("ext_asset_address").value=obj_data.address;
            refreshExtAssetAddressSummary();
        }
    }

    document.getElementById("btn_send_ext_asset").disabled=false;
    //document.getElementById("ext_asset_change_address").disabled=false;
    //document.getElementById("ext_asset_new_address").disabled=false;
    //document.getElementById("ext_asset_import_prvkey").disabled=false;
}

function refreshExtAssetAddressSummary(){
    document.getElementById("ext_asset_summary").innerHTML="...";
    //document.getElementById("odin_register_num").innerHTML="...";
    //document.getElementById("last_register_odin").innerHTML="...";
    //document.getElementById("unconfirmed_tx_count").innerHTML="...";

    var asset_uri=ext_asset_list.options[ ext_asset_list.selectedIndex ].value;
    if(asset_uri!='ppk:bch/'){
        //alert('暂时不支持的资产币种：'.asset_uri);
        return ;
    }
    
    var ext_asset_address=document.getElementById("ext_asset_address").value;
    if(ext_asset_address.length == 0 ){
        return;
    }
    
    //读取指定比特币地址的概要汇总信息
    PeerWeb.getAddressSummary(
        asset_uri,  
        ext_asset_address,
        'callback_getExtAssetAddressSummary'  //回调方法名称
    );
}

function callback_getExtAssetAddressSummary(status,obj_data){
    if('OK'==status){
        if(obj_data!=null){
            if(typeof(obj_data.balance_satoshi) !== 'undefined'){
                document.getElementById("ext_asset_summary").innerHTML="余额:"+ (obj_data.balance_satoshi/BTC_SATOSHI_UNIT)+" BCH";
            }
        }
    }
}

//转账发送更多数字资产的示例
function sendExtAsset(){
    var ext_asset_list=document.getElementById("ext_asset_list");
    
    var asset_uri=ext_asset_list.options[ ext_asset_list.selectedIndex ].value;
    
    if(asset_uri!='ppk:bch/'){
        alert('暂时不支持的资产币种：'.asset_uri);
        return ;
    }
    
    var ext_asset_address=document.getElementById("ext_asset_address").value;
    
    if(ext_asset_address.length ==0 ){
        alert('该资产地址尚未设置，请先创建或导入一个该资产对应的币种地址！');
        return;
    }
 
    var dest_address = prompt("请输入收款的奥丁号（以ppk:起始）或比特现金公开地址（以1,3,q或p起始）","");
    if (dest_address != null){
        dest_address=dest_address.replace("：",":").replace("PPK:","ppk:"); //替换容易输错的字符
        if( dest_address.substr(0,1)=='1' 
         || dest_address.substr(0,1)=='3' 
         || dest_address.substr(0,1)=='q' 
         || dest_address.substr(0,1)=='p' 
         || dest_address.substr(0,12)=='bitcoincash:' 
         || dest_address.substr(0,4)=='ppk:' ){
            var send_amount = prompt("请输入要发送给\n"+dest_address+"\n的比特现金（BCH)数额：","0.0");
            if (send_amount != null){
                if(!isNaN(send_amount)){
                    var send_amount_satoshi= Math.round( parseFloat(send_amount) * BTC_SATOSHI_UNIT );
                    var tx_argus_json='{"source":"'+ext_asset_address             //交易发送者地址
                                     +'","destination":"'+dest_address                 //交易接收者地址
                                     +'","amount_satoshi":'+send_amount_satoshi //转账金额,单位satoshi
                                     +',"fee_satoshi":'+MIN_FEE_SATOSHI+'}';    //给矿工的费用,单位satoshi
                    
                    document.getElementById("btn_send_ext_asset").disabled=true;
                    document.getElementById("btn_send_ext_asset").innerHTML="正在处理，请稍候...";
    
                    PeerWeb.getSignedTX(
                        'ppk:bch/',
                        stringToHex(tx_argus_json),  //待生成交易的参数数据
                        'callback_getExtAssetSignedTX'
                      );
                }else{
                    alert("输入的金额数值无效！");
                }
             }
        }else{
            alert("请在地址文本框里输入对方收款的奥丁号（以ppk:起始）或比特现金公开地址（以以1,3,q或p起始起始）！");
        }
    }
}

function callback_getExtAssetSignedTX(status,obj_data){
    if('OK'==status){
        var ext_asset_address=document.getElementById("ext_asset_address").value;
        var asset_uri=ext_asset_list.options[ ext_asset_list.selectedIndex ].value;
        if(asset_uri!='ppk:bch/'){
            alert('暂时不支持的资产币种：'.asset_uri);
            return ;
        }
    
        //调用PeerWeb接口发送已签名的比特币交易
        PeerWeb.sendSignedTX(
                asset_uri,
                ext_asset_address,  //交易发送者地址
                obj_data.signed_tx_hex,  //已签名的比特币交易数据，HEX格式
                'callback_sendExtAssetTX' //回调方法 
            );
    }else{
        if('CANCELED'!=status){
            alert("比特现金的转账交易失败!\n(status="+status+")\n请确认当前的地址有足够余额.");
        }
        document.getElementById("btn_send_ext_asset").disabled=false;
        document.getElementById("btn_send_ext_asset").innerHTML="发送比特现金";
    }
}

function callback_sendExtAssetTX(status,obj_data){
    if('OK'==status){
        refreshExtAssetAddressSummary();
        alert("已发出比特现金转账交易!\点击左侧余额可以查看交易确认状态.");
    }else{
        alert("发送比特现金失败!\n(status="+status+")\n网络服务可能有异常，请稍后再试.");
    }
    document.getElementById("btn_send_ext_asset").disabled=false;
    document.getElementById("btn_send_ext_asset").innerHTML="发送比特现金";
}

   
//Ascii/Unicode字符串转换成16进制表示
function stringToHex(str){
    var val="";
    for(var i = 0; i < str.length; i++){
        var tmpstr=str.charCodeAt(i).toString(16);  //Unicode
        val += tmpstr.length==1? '0'+tmpstr : tmpstr;  
    }
    return val;
}

/** 
 * 得到UTF8编码的字节数组 
 * @param text 需要转换的原字符串 
 * @return  转换后的字节数组 
 */  
function encodeUtf8(text) {
    var code = encodeURIComponent(text);
    var bytes = [];
    for (var i = 0; i < code.length; i++) {
        var c = code.charAt(i);
        if (c === '%') {
            var hex = code.charAt(i + 1) + code.charAt(i + 2);
            var hexVal = parseInt(hex, 16);
            bytes.push(hexVal);
            i += 2;
        } else bytes.push(c.charCodeAt(0));
    }
    return bytes;
}

/** 
 * 将UTF8编码的字节数组转换成普通Unicode字符串 
 * @param text 需要转换字节数组 
 * @return  转换后的Unicode字符串
 */  
function decodeUtf8(bytes) {
    var encoded = "";
    for (var i = 0; i < bytes.length; i++) {
        encoded += '%' + bytes[i].toString(16);
    }
    return decodeURIComponent(encoded);
}

/** 
 * 字节数组转16进制 
 * @param bytes 需要转换的byte数组 
 * @return  转换后的Hex字符串 
 */  
function bytesToHex(bytes) {
    for (var hex = [], i = 0; i < bytes.length; i++) { 
        hex.push(((bytes[i] >>> 4) & 0xF).toString(16).toUpperCase());
        hex.push((bytes[i] & 0xF).toString(16).toUpperCase());
    }
    return hex.join("");
}
</script>
</body>
